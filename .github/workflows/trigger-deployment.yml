name: Trigger Dokploy Deployment

on:
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'Deploy backend service'
        type: boolean
        default: true
      deploy_frontend:
        description: 'Deploy frontend service'
        type: boolean
        default: true
  workflow_call:
    inputs:
      deploy_backend:
        description: 'Deploy backend service'
        type: boolean
        required: false
        default: true
      deploy_frontend:
        description: 'Deploy frontend service'
        type: boolean
        required: false
        default: true

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    if: inputs.deploy_backend == true

    env:
      CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
      CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
      DEPLOY_HOOK_URL: ${{ secrets.DOKPLOY_BACKEND_DEPLOY_HOOK_URL }}

    steps:
      - name: Trigger Backend Deployment
        if: env.DEPLOY_HOOK_URL != ''
        env:
          CF_ACCESS_CLIENT_ID: ${{ env.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ env.CF_ACCESS_CLIENT_SECRET }}
        run: |
          echo "Triggering Backend Dokploy deployment..."
          echo "=================================================="
          
          HTTP_CODE=$(curl -X POST "$DEPLOY_HOOK_URL" \
            -H "Content-Type: application/json" \
            -H "CF-Access-Client-Id: $CF_ACCESS_CLIENT_ID" \
            -H "CF-Access-Client-Secret: $CF_ACCESS_CLIENT_SECRET" \
            -A "SananMaarouf-GitHub-Actions-Deploy-Script" \
            -d '{}' \
            -w "%{http_code}" \
            -o /tmp/backend_response.txt \
            -v \
            -L \
            --max-time 30 \
            --connect-timeout 10 \
            2>&1 | tee /tmp/backend_curl_debug.txt | tail -1)
          
          RESPONSE_BODY=$(cat /tmp/backend_response.txt 2>/dev/null || echo "No response body")
          
          echo ""
          echo "üìä Response Status: $HTTP_CODE"
          echo "=================================================="
          
          if echo "$RESPONSE_BODY" | jq . > /dev/null 2>&1; then
            echo "üìÑ Response Body (formatted):"
            echo "$RESPONSE_BODY" | jq .
            IS_JSON=true
          elif echo "$RESPONSE_BODY" | grep -q "<html"; then
            echo "üìÑ Response Body (HTML - extracted text):"
            TITLE=$(echo "$RESPONSE_BODY" | grep -oP '(?<=<title>)[^<]+' || echo "")
            ERROR_MSG=$(echo "$RESPONSE_BODY" | sed 's/<[^>]*>//g' | grep -v '^[[:space:]]*$' | head -20)
            if [ -n "$TITLE" ]; then
              echo "Title: $TITLE"
              echo ""
            fi
            echo "$ERROR_MSG"
            IS_JSON=false
          else
            echo "üìÑ Response Body:"
            echo "$RESPONSE_BODY"
            IS_JSON=false
          fi
          echo "=================================================="
          
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 204 ]; then
            echo "‚úÖ Backend deployment triggered successfully!"
            exit 0
          fi
          
          if [ "$HTTP_CODE" -eq 403 ]; then
            echo ""
            echo "‚ùå Error: Access Denied (403)"
            echo "=================================================="
            if [ "$IS_JSON" = true ]; then
               echo "üëâ This looks like a BACKEND error (from Dokploy), not Cloudflare."
               echo "   Check if your DOKPLOY_BACKEND_DEPLOY_HOOK_URL is correct."
            else
               echo "üëâ This looks like a CLOUDFLARE error."
               echo "   Possible issues:"
               echo "   1. WAF/Bot Fight Mode is blocking the request."
               echo "   2. Service Token is not correctly added to the policy."
               echo "   3. The policy Action is not set to 'Service Auth'."
            fi
            echo ""
            echo "üîç Cloudflare-related debug info:"
            grep -i "cloudflare" /tmp/backend_curl_debug.txt || echo "  (none found)"
            exit 1
          elif [ "$HTTP_CODE" -eq 0 ] || [ "$HTTP_CODE" -eq 000 ]; then
            echo ""
            echo "‚ùå Error: Connection failed - request did not reach server"
            echo "=================================================="
            echo "Possible issues:"
            echo "  - Network timeout"
            echo "  - DNS resolution failure"
            echo "  - Cloudflare blocking at network level"
            echo ""
            echo "üîç Full debug info:"
            cat /tmp/backend_curl_debug.txt
            exit 1
          elif [ "$HTTP_CODE" -ge 500 ]; then
            echo ""
            echo "‚ö†Ô∏è  Warning: Server error ($HTTP_CODE)"
            echo "=================================================="
            echo "The request reached the server but it returned an error"
            exit 1
          else
            echo ""
            echo "‚ö†Ô∏è  Warning: Unexpected response code: $HTTP_CODE"
            echo "=================================================="
            echo "üîç Full debug output:"
            cat /tmp/backend_curl_debug.txt
            exit 1
          fi

  deploy-frontend:
    runs-on: ubuntu-latest
    if: inputs.deploy_frontend == true

    env:
      CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
      CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
      DEPLOY_HOOK_URL: ${{ secrets.DOKPLOY_FRONTEND_DEPLOY_HOOK_URL }}

    steps:
      - name: Trigger Frontend Deployment
        if: env.DEPLOY_HOOK_URL != ''
        env:
          CF_ACCESS_CLIENT_ID: ${{ env.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ env.CF_ACCESS_CLIENT_SECRET }}
        run: |
          echo "Triggering Frontend Dokploy deployment..."
          echo "=================================================="
          
          HTTP_CODE=$(curl -X POST "$DEPLOY_HOOK_URL" \
            -H "Content-Type: application/json" \
            -H "CF-Access-Client-Id: $CF_ACCESS_CLIENT_ID" \
            -H "CF-Access-Client-Secret: $CF_ACCESS_CLIENT_SECRET" \
            -A "SananMaarouf-GitHub-Actions-Deploy-Script" \
            -d '{}' \
            -w "%{http_code}" \
            -o /tmp/frontend_response.txt \
            -v \
            -L \
            --max-time 30 \
            --connect-timeout 10 \
            2>&1 | tee /tmp/frontend_curl_debug.txt | tail -1)
          
          RESPONSE_BODY=$(cat /tmp/frontend_response.txt 2>/dev/null || echo "No response body")
          
          echo ""
          echo "üìä Response Status: $HTTP_CODE"
          echo "=================================================="
          
          if echo "$RESPONSE_BODY" | jq . > /dev/null 2>&1; then
            echo "üìÑ Response Body (formatted):"
            echo "$RESPONSE_BODY" | jq .
            IS_JSON=true
          elif echo "$RESPONSE_BODY" | grep -q "<html"; then
            echo "üìÑ Response Body (HTML - extracted text):"
            TITLE=$(echo "$RESPONSE_BODY" | grep -oP '(?<=<title>)[^<]+' || echo "")
            ERROR_MSG=$(echo "$RESPONSE_BODY" | sed 's/<[^>]*>//g' | grep -v '^[[:space:]]*$' | head -20)
            if [ -n "$TITLE" ]; then
              echo "Title: $TITLE"
              echo ""
            fi
            echo "$ERROR_MSG"
            IS_JSON=false
          else
            echo "üìÑ Response Body:"
            echo "$RESPONSE_BODY"
            IS_JSON=false
          fi
          echo "=================================================="
          
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 204 ]; then
            echo "‚úÖ Frontend deployment triggered successfully!"
            exit 0
          fi
          
          if [ "$HTTP_CODE" -eq 403 ]; then
            echo ""
            echo "‚ùå Error: Access Denied (403)"
            echo "=================================================="
            if [ "$IS_JSON" = true ]; then
               echo "üëâ This looks like a BACKEND error (from Dokploy), not Cloudflare."
               echo "   Check if your DOKPLOY_FRONTEND_DEPLOY_HOOK_URL is correct."
            else
               echo "üëâ This looks like a CLOUDFLARE error."
               echo "   Possible issues:"
               echo "   1. WAF/Bot Fight Mode is blocking the request."
               echo "   2. Service Token is not correctly added to the policy."
               echo "   3. The policy Action is not set to 'Service Auth'."
            fi
            echo ""
            echo "üîç Cloudflare-related debug info:"
            grep -i "cloudflare" /tmp/frontend_curl_debug.txt || echo "  (none found)"
            exit 1
          elif [ "$HTTP_CODE" -eq 0 ] || [ "$HTTP_CODE" -eq 000 ]; then
            echo ""
            echo "‚ùå Error: Connection failed - request did not reach server"
            echo "=================================================="
            echo "Possible issues:"
            echo "  - Network timeout"
            echo "  - DNS resolution failure"
            echo "  - Cloudflare blocking at network level"
            echo ""
            echo "üîç Full debug info:"
            cat /tmp/frontend_curl_debug.txt
            exit 1
          elif [ "$HTTP_CODE" -ge 500 ]; then
            echo ""
            echo "‚ö†Ô∏è  Warning: Server error ($HTTP_CODE)"
            echo "=================================================="
            echo "The request reached the server but it returned an error"
            exit 1
          else
            echo ""
            echo "‚ö†Ô∏è  Warning: Unexpected response code: $HTTP_CODE"
            echo "=================================================="
            echo "üîç Full debug output:"
            cat /tmp/frontend_curl_debug.txt
            exit 1
          fi
